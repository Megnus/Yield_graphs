<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Yield Progressbars</title>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css">

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>

	<style></style>

	<script type="text/javascript">

		function aggregateData(response) {
			data = {};
			for (var index in response.d) {
				if (data[response.d[index]['sn']] == null) { //=== undefined?
					data[response.d[index]['sn']] = [];
				}

				data[response.d[index]['sn']].push([
					response.d[index]['date'].substring(0, 7), 
					response.d[index]['pass']]);
			}

			var uniqueIdentities = [];
			for (var index in data) {
				uniqueIdentities.push(index);
				console.log(index + ' : ' + data[index].length);
			}

			var firstDateStr = data[uniqueIdentities[0]][0][0];
			var lastDateStr = data[uniqueIdentities[0]][data[uniqueIdentities[0]].length - 1][0];
			var firstDate = new Date(firstDateStr + '-01');
			var lastDate = new Date(lastDateStr + '-01');
			var dateArray = {};

			for (var date = firstDate; date <= lastDate; date = new Date(date.setMonth(date.getMonth() + 1))) {
				console.log(date.toLocaleDateString().substring(0, 7));
				var dateMonth = date.toLocaleDateString().substring(0, 7);
				console.log(date.toLocaleDateString() + ' ' + date.toLocaleTimeString());
				dateArray[dateMonth] = { date : dateMonth, pass : 0, total : 0, yield : 0.0 }
			}

			var array = data[uniqueIdentities[0]];
			for (var index in array) {
				var value = array[index];
				var dateMonth = value[0];
				dateArray[dateMonth].total++;
				dateArray[dateMonth].pass += Number(value[1]);
				dateArray[dateMonth].yield = dateArray[dateMonth].pass / dateArray[dateMonth].total;
				
			}

			for (var index in dateArray) {
				console.log(dateArray[index])
			}
		}

		function generateFakeData() {
			var response = { d : [] };
			var sn = [];
			var date = new Date(2015, 0, 1, 16, 10, 10);

			for (var i = 0; i < 10; i++) {
				sn.push(Math.round(Math.random() * 500 + 400));
			}

			for (var i = 0; i < 19608; i++) {
				date = new Date(new Date(date).setMinutes(date.getMinutes() + Math.random() * 60));
				response.d.push({
					sn : String(sn[Math.round(Math.random() * 9)]), 
					date : date.toLocaleDateString() + ' ' + date.toLocaleTimeString(), 
					pass : String(Math.round(Math.random()))});
			}

			return response;
		}

		aggregateData(generateFakeData());
	</script>

</head>
<body>
	<h3 class="offset">
		Data is printed in the console</h3>
	<div id="container">
	</div>
</body>
</html>
